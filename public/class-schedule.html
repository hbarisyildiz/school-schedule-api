<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÄ±nÄ±f Saatleri - Okul YÃ¶netim Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* Top Navigation */
        .top-nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            flex-shrink: 0;
        }
        
        .nav-left .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
        }
        
        .nav-left .logo i {
            font-size: 24px;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .btn-back {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-back:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
            overflow: hidden;
        }
        
        .content-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .content-body {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f5f5f5;
        }
        
        /* Schedule Grid */
        .schedule-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .schedule-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .schedule-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }
        
        .schedule-grid {
            padding: 20px;
        }
        
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        
        .schedule-table th {
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            padding: 15px 10px;
            text-align: center;
            border: 1px solid #e9ecef;
            font-size: 14px;
        }
        
        .schedule-table th:first-child {
            background: #e9ecef;
            text-align: left;
            padding-left: 20px;
            width: 120px;
        }
        
        .schedule-table td {
            padding: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
            vertical-align: middle;
        }
        
        .schedule-table td:first-child {
            background: #f8f9fa;
            font-weight: 600;
            text-align: left;
            padding-left: 20px;
            color: #2c3e50;
        }
        
        .clickable-day {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .clickable-day:hover {
            background: #e3f2fd !important;
            color: #1976d2 !important;
        }
        
        .clickable-day::after {
            content: 'ðŸ‘†';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            opacity: 0.6;
        }
        
        .subject-cell {
            width: 100%;
            height: 100%;
            min-height: 40px;
            border: 2px solid white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .subject-cell.available {
            background: #28a745;
        }
        
        .subject-cell.unavailable {
            background: #dc3545;
        }
        
        .subject-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .subject-cell.editable {
            cursor: pointer;
        }
        
        .subject-cell.editable:hover {
            background: #17a2b8;
        }
        
        /* Legend */
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid white;
        }
        
        .legend-color.available {
            background: #28a745;
        }
        
        .legend-color.unavailable {
            background: #dc3545;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        
        .btn-action {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .btn-action.primary {
            background: #007bff;
            color: white;
        }
        
        .btn-action.success {
            background: #28a745;
            color: white;
        }
        
        .btn-action.danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-action:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* Loading and Error States */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="app-container">
            <!-- Top Navigation -->
            <nav class="top-nav">
                <div class="nav-left">
                    <div class="logo">
                        <i class="fas fa-school"></i>
                        <span>{{ classData.name || 'SÄ±nÄ±f Saatleri' }}</span>
                    </div>
                </div>
                
                <div class="nav-right">
                    <a href="/admin-panel.html?tab=classes" class="btn-back">
                        <i class="fas fa-arrow-left"></i>
                        <span>Geri DÃ¶n</span>
                    </a>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="main-content">
                <div class="content-header">
                    <h1 class="page-title">
                        <i class="fas fa-clock"></i>
                        SÄ±nÄ±f Saatleri
                    </h1>
                </div>
                
                <div class="content-body">
                    <!-- Success Message -->
                    <div v-if="message" class="alert alert-success">
                        <i class="fas fa-check-circle"></i> {{ message }}
                    </div>
                    
                    <!-- Error Message -->
                    <div v-if="error" class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> {{ error }}
                    </div>

                    <!-- Loading State -->
                    <div v-if="isLoading" class="loading-container">
                        <div class="spinner"></div>
                        <h3>SÄ±nÄ±f saatleri yÃ¼kleniyor...</h3>
                        <p>LÃ¼tfen bekleyin...</p>
                    </div>

                    <!-- Schedule Grid -->
                    <div v-else class="schedule-container">
                        <div class="schedule-header">
                            <h2 class="schedule-title">{{ classData.name || 'SÄ±nÄ±f' }} HaftalÄ±k Ders ProgramÄ±</h2>
                        </div>
                        
                        <div class="schedule-grid">
                            <table class="schedule-table">
                                <thead>
                                    <tr>
                                        <th>GÃ¼n</th>
                                        <th v-for="period in dailyLessonCount" :key="period">{{ period }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(day, dayKey) in dayLabels" :key="dayKey">
                                        <td 
                                            @click="toggleDay(dayKey)"
                                            :class="{ 'clickable-day': schoolSettings.class_days.includes(dayKey) }"
                                            :title="schoolSettings.class_days.includes(dayKey) ? 'TÃ¼m gÃ¼nÃ¼ deÄŸiÅŸtirmek iÃ§in tÄ±klayÄ±n' : 'Bu gÃ¼n ders gÃ¼nÃ¼ deÄŸil'"
                                        >
                                            {{ day }}
                                        </td>
                                        <td v-for="period in dailyLessonCount" :key="period">
                                            <div 
                                                :class="['subject-cell', getCellClass(dayKey, period)]"
                                                @click="toggleCell(dayKey, period)"
                                            >
                                                {{ getSubjectAbbreviation(dayKey, period) }}
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- Legend -->
                            <div class="legend">
                                <div class="legend-item">
                                    <div class="legend-color available"></div>
                                    <span>Uygun</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color unavailable"></div>
                                    <span>Uygun DeÄŸil</span>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="action-buttons">
                                <button class="btn-action success" @click="saveSchedule" :disabled="isSaving" title="Kaydet">
                                    <i v-if="isSaving" class="fas fa-spinner fa-spin"></i>
                                    <i v-else class="fas fa-check"></i>
                                    {{ isSaving ? 'Kaydediliyor...' : 'Kaydet' }}
                                </button>
                                <button class="btn-action danger" @click="cancel" title="Ä°ptal">
                                    <i class="fas fa-times"></i>
                                    Ä°ptal
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        const { createApp } = Vue;
        const API_BASE_URL = 'http://localhost:8000/api';

        createApp({
            data() {
                return {
                    classData: {},
                    classScheduleData: {},
                    scheduleGrid: {}, // Grid verileri: {day: {period: {subject: 'MAT', available: true}}}
                    isLoading: true,
                    isSaving: false,
                    error: '',
                    message: '',
                    dailyLessonCount: 8, // Ayarlar sayfasÄ±ndan gelecek
                    dayLabels: {
                        monday: 'Pazartesi',
                        tuesday: 'SalÄ±',
                        wednesday: 'Ã‡arÅŸamba',
                        thursday: 'PerÅŸembe',
                        friday: 'Cuma',
                        saturday: 'Cumartesi',
                        sunday: 'Pazar'
                    },
                    schoolSettings: {
                        class_days: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
                    },
                    // Ders kÄ±saltmalarÄ±
                    subjectAbbreviations: {
                        'matematik': 'MAT',
                        'tÃ¼rkÃ§e': 'TDE',
                        'fizik': 'FÄ°Z',
                        'kimya': 'KÄ°M',
                        'biyoloji': 'BÄ°O',
                        'tarih': 'TRH',
                        'coÄŸrafya': 'COÄž',
                        'ingilizce': 'Ä°NG',
                        'almanca': 'ALM',
                        'fransÄ±zca': 'FRA',
                        'din kÃ¼ltÃ¼rÃ¼': 'DÄ°N',
                        'beden eÄŸitimi': 'BED',
                        'mÃ¼zik': 'MÃœZ',
                        'resim': 'RES',
                        'edebiyat': 'EDB',
                        'felsefe': 'FEL',
                        'psikoloji': 'PSK',
                        'sosyoloji': 'SOS',
                        'mantÄ±k': 'MAN',
                        'geometri': 'GEO',
                        'analitik geometri': 'AGE',
                        'tÃ¼rk edebiyatÄ±': 'TED',
                        'dil ve anlatÄ±m': 'DAN',
                        'tÃ¼rk dili ve edebiyatÄ±': 'TDE',
                        'tÃ¼rk edebiyatÄ± ve dil anlatÄ±m': 'TED',
                        'tÃ¼rk dili ve edebiyatÄ±': 'TDE',
                        'tÃ¼rk edebiyatÄ±': 'TED',
                        'dil anlatÄ±m': 'DAN',
                        'tÃ¼rk dili': 'TDE',
                        'edebiyat': 'EDB',
                        'tÃ¼rk edebiyatÄ±': 'TED',
                        'dil ve anlatÄ±m': 'DAN',
                        'tÃ¼rk dili ve edebiyatÄ±': 'TDE',
                        'tÃ¼rk edebiyatÄ± ve dil anlatÄ±m': 'TED',
                        'tÃ¼rk dili ve edebiyatÄ±': 'TDE',
                        'tÃ¼rk edebiyatÄ±': 'TED',
                        'dil anlatÄ±m': 'DAN',
                        'tÃ¼rk dili': 'TDE',
                        'edebiyat': 'EDB'
                    }
                }
            },
            async mounted() {
                // Token kontrolÃ¼
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    window.location.href = '/admin-panel';
                    return;
                }
                
                axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                
                // TÃ¼m API Ã§aÄŸrÄ±larÄ±nÄ± paralel yap
                await Promise.all([
                    this.loadClassData(),
                    this.loadClassSchedule(),
                    this.loadSchoolSettings()
                ]);
            },
            methods: {
                async loadClassData() {
                    try {
                        const classId = new URLSearchParams(window.location.search).get('id');
                        if (!classId) {
                            this.error = 'SÄ±nÄ±f ID bulunamadÄ±';
                            return;
                        }

                        const token = localStorage.getItem('auth_token');
                        if (!token) {
                            this.error = 'Oturum sÃ¼resi dolmuÅŸ. LÃ¼tfen tekrar giriÅŸ yapÄ±n.';
                            return;
                        }

                        const response = await axios.get(`${API_BASE_URL}/classes/${classId}`, {
                            headers: { Authorization: `Bearer ${token}` },
                            timeout: 3000 // 3 saniye timeout
                        });
                        this.classData = response.data;
                    } catch (error) {
                        if (error.response?.status === 401) {
                            this.error = 'Oturum sÃ¼resi dolmuÅŸ. LÃ¼tfen tekrar giriÅŸ yapÄ±n.';
                        } else {
                            this.error = 'SÄ±nÄ±f bilgileri yÃ¼klenemedi';
                        }
                        console.error('Load class error:', error);
                    }
                },

                async loadClassSchedule() {
                    try {
                        const token = localStorage.getItem('auth_token');
                        const response = await axios.get(`${API_BASE_URL}/school/class-daily-schedules`, {
                            headers: { Authorization: `Bearer ${token}` },
                            timeout: 3000 // 3 saniye timeout
                        });

                        // Bu sÄ±nÄ±fÄ±n verilerini filtrele
                        const classSchedules = response.data.filter(s => s.class_id === this.classData.id);
                        
                        if (classSchedules.length > 0) {
                            // Mevcut veriyi yÃ¼kle
                            this.classScheduleData = {};
                            classSchedules.forEach(schedule => {
                                this.classScheduleData[schedule.day] = schedule.lesson_count;
                            });
                        } else {
                            // VarsayÄ±lan deÄŸerler
                            this.classScheduleData = {
                                monday: 8,
                                tuesday: 8,
                                wednesday: 8,
                                thursday: 8,
                                friday: 8
                            };
                        }
                    } catch (error) {
                        console.error('SÄ±nÄ±f saatleri yÃ¼klenemedi:', error);
                        // Hata durumunda varsayÄ±lan deÄŸerler
                        this.classScheduleData = {
                            monday: 8,
                            tuesday: 8,
                            wednesday: 8,
                            thursday: 8,
                            friday: 8
                        };
                    }
                },

                async loadSchoolSettings() {
                    try {
                        const token = localStorage.getItem('auth_token');
                        const response = await axios.get(`${API_BASE_URL}/school/settings`, {
                            headers: { Authorization: `Bearer ${token}` },
                            timeout: 3000 // 3 saniye timeout
                        });
                        this.schoolSettings = response.data;
                        
                        // GÃ¼nlÃ¼k ders sayÄ±sÄ±nÄ± ayarlar sayfasÄ±ndan al
                        this.dailyLessonCount = response.data.daily_lesson_count || 8;
                        
                        // Grid'i baÅŸlat
                        this.initializeGrid();
                    } catch (error) {
                        console.error('Okul ayarlarÄ± yÃ¼klenemedi:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },

                initializeGrid() {
                    // Grid'i baÅŸlat - her gÃ¼n ve her ders saati iÃ§in
                    this.scheduleGrid = {};
                    
                    Object.keys(this.dayLabels).forEach(day => {
                        this.scheduleGrid[day] = {};
                        for (let period = 1; period <= this.dailyLessonCount; period++) {
                            const isActiveDay = this.schoolSettings.class_days.includes(day);
                            const lessonCount = this.classScheduleData[day] || 0;
                            
                            this.scheduleGrid[day][period] = {
                                available: isActiveDay && period <= lessonCount
                            };
                        }
                    });
                },

                getRandomSubject() {
                    const subjects = ['MAT', 'TDE', 'FÄ°Z', 'KÄ°M', 'BÄ°O', 'TRH', 'COÄž', 'Ä°NG', 'DÄ°N', 'BED', 'MÃœZ', 'RES'];
                    return subjects[Math.floor(Math.random() * subjects.length)];
                },

                getCellClass(day, period) {
                    const cell = this.scheduleGrid[day]?.[period];
                    if (!cell) return 'unavailable';
                    
                    return cell.available ? 'available' : 'unavailable';
                },

                getSubjectAbbreviation(day, period) {
                    // Åžu anda ders programÄ± yok, hÃ¼creler boÅŸ olsun
                    return '';
                },

                toggleCell(day, period) {
                    // Sadece aktif gÃ¼nlerde iÅŸlem yap
                    if (!this.schoolSettings.class_days.includes(day)) return;
                    
                    if (!this.scheduleGrid[day]) {
                        this.scheduleGrid[day] = {};
                    }
                    
                    if (!this.scheduleGrid[day][period]) {
                        this.scheduleGrid[day][period] = {
                            available: false
                        };
                    }
                    
                    // Durumu deÄŸiÅŸtir
                    this.scheduleGrid[day][period].available = !this.scheduleGrid[day][period].available;
                    
                    // Ders sayÄ±sÄ±nÄ± gÃ¼ncelle
                    this.updateLessonCount(day);
                },

                toggleDay(day) {
                    // GÃ¼n ismine tÄ±klandÄ±ÄŸÄ±nda tÃ¼m gÃ¼nÃ¼ deÄŸiÅŸtir
                    if (!this.schoolSettings.class_days.includes(day)) return;
                    
                    if (!this.scheduleGrid[day]) {
                        this.scheduleGrid[day] = {};
                    }
                    
                    // GÃ¼nÃ¼n mevcut durumunu kontrol et
                    const currentLessonCount = this.classScheduleData[day] || 0;
                    const isFullyActive = currentLessonCount === this.dailyLessonCount;
                    
                    // TÃ¼m gÃ¼nÃ¼ aktif/pasif yap
                    for (let period = 1; period <= this.dailyLessonCount; period++) {
                        this.scheduleGrid[day][period] = {
                            available: !isFullyActive
                        };
                    }
                    
                    // Ders sayÄ±sÄ±nÄ± gÃ¼ncelle
                    this.classScheduleData[day] = !isFullyActive ? this.dailyLessonCount : 0;
                },

                updateLessonCount(day) {
                    if (!this.scheduleGrid[day]) return;
                    
                    let count = 0;
                    for (let period = 1; period <= this.dailyLessonCount; period++) {
                        if (this.scheduleGrid[day][period]?.available) {
                            count = period;
                        }
                    }
                    
                    this.classScheduleData[day] = count;
                },

                isDayActive(day) {
                    return this.schoolSettings.class_days.includes(day);
                },

                getTotalWeeklyHours() {
                    return Object.values(this.classScheduleData).reduce((total, hours) => total + (hours || 0), 0);
                },


                cancel() {
                    window.location.href = '/admin-panel#classes';
                },

                async saveSchedule() {
                    this.isSaving = true;
                    this.error = '';
                    this.message = '';

                    try {
                        const token = localStorage.getItem('auth_token');
                        const schedules = [];
                        
                        // Her gÃ¼n iÃ§in schedule objesi oluÅŸtur
                        for (const day of ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']) {
                            schedules.push({
                                day: day,
                                lesson_count: this.classScheduleData[day] || 0
                            });
                        }

                        // PUT metodu kullan ve classId'yi URL'de gÃ¶nder
                        await axios.put(`${API_BASE_URL}/school/class-daily-schedules/${this.classData.id}`, {
                            schedules: schedules
                        }, {
                            headers: { Authorization: `Bearer ${token}` }
                        });

                        this.message = 'SÄ±nÄ±f saatleri baÅŸarÄ±yla kaydedildi';
                        
                        // 2 saniye sonra sÄ±nÄ±flar sayfasÄ±na yÃ¶nlendir
                        setTimeout(() => {
                            window.location.href = '/admin-panel#classes';
                        }, 2000);

                    } catch (error) {
                        this.error = error.response?.data?.message || 'SÄ±nÄ±f saatleri kaydedilemedi';
                        console.error('Save schedule error:', error);
                    } finally {
                        this.isSaving = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
